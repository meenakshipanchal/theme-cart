{% liquid
  comment
    =====================================================
    REWARDS PROGRESS BAR - BOOLEAN CONFIG
    =====================================================
    Toggle milestones ON/OFF with true/false.
    Free Shipping is ALWAYS first when enabled.
    Milestones appear leftâ†’right in this order:
      1. Free Shipping  2. Free Gift
      3. Premium Gift   4. VIP Reward
    =====================================================
  endcomment

  assign enable_free_shipping = true
  assign shipping_threshold = 49900
  assign shipping_display = '499'
  assign shipping_label = 'Free Delivery'
  assign shipping_msg = 'FREE Delivery'

  assign enable_free_gift = true
  assign gift_threshold = 149900
  assign gift_display = '1499'
  assign gift_label = 'Free Gift'
  assign gift_msg = 'a FREE Gift'

  assign enable_premium_gift = true
  assign premium_threshold = 299900
  assign premium_display = '2999'
  assign premium_label = 'Premium Gift'
  assign premium_msg = 'a Premium Gift'

  assign enable_vip_reward = false
  assign vip_threshold = 349900
  assign vip_display = '3499'
  assign vip_label = 'VIP Reward'
  assign vip_msg = 'VIP Reward'

  comment
    Calculate cart total excluding freebie items
  endcomment
  assign freebie_cart_total = 0
  for item in cart.items
    if item.properties._freebie
      assign freebie_cart_total = freebie_cart_total | plus: item.final_line_price
    endif
  endfor
  assign current_cart_total = cart.total_price | minus: freebie_cart_total

  comment
    Build active milestones list as | separated string
    Format: threshold:display:label:msg:icon per entry
  endcomment
  assign ms_list = ''
  if enable_free_shipping
    assign entry = shipping_threshold | append: ':' | append: shipping_display | append: ':' | append: shipping_label | append: ':' | append: shipping_msg | append: ':truck'
    if ms_list == ''
      assign ms_list = entry
    else
      assign ms_list = ms_list | append: '|' | append: entry
    endif
  endif
  if enable_free_gift
    assign entry = gift_threshold | append: ':' | append: gift_display | append: ':' | append: gift_label | append: ':' | append: gift_msg | append: ':gift'
    if ms_list == ''
      assign ms_list = entry
    else
      assign ms_list = ms_list | append: '|' | append: entry
    endif
  endif
  if enable_premium_gift
    assign entry = premium_threshold | append: ':' | append: premium_display | append: ':' | append: premium_label | append: ':' | append: premium_msg | append: ':star'
    if ms_list == ''
      assign ms_list = entry
    else
      assign ms_list = ms_list | append: '|' | append: entry
    endif
  endif
  if enable_vip_reward
    assign entry = vip_threshold | append: ':' | append: vip_display | append: ':' | append: vip_label | append: ':' | append: vip_msg | append: ':percent'
    if ms_list == ''
      assign ms_list = entry
    else
      assign ms_list = ms_list | append: '|' | append: entry
    endif
  endif

  assign milestones = ms_list | split: '|'
  assign ms_count = milestones.size

  comment
    Find next unreached milestone for message
  endcomment
  assign all_done = true
  assign next_msg = ''
  assign next_rem = 0
  for ms in milestones
    assign parts = ms | split: ':'
    assign ms_t = parts[0] | plus: 0
    assign ms_msg = parts[3]
    if current_cart_total < ms_t and next_msg == ''
      assign all_done = false
      assign next_msg = ms_msg
      assign next_rem = ms_t | minus: current_cart_total | divided_by: 100
    endif
  endfor

  comment
    Calculate overall progress % using loop (no variable indexing)
    Milestones are positioned at 0%, 50%, 100% (tracking-bar style)
    segment_size = 100 / (N-1) for spacing between milestones
  endcomment
  if ms_count > 1
    assign ms_gaps = ms_count | minus: 1
    assign segment_size = 100 | divided_by: ms_gaps
  else
    assign segment_size = 100
  endif
  assign overall_progress = 0
  assign prev_threshold = 0
  assign progress_done = false

  for ms in milestones
    assign parts = ms | split: ':'
    assign ms_t = parts[0] | plus: 0
    assign seg_index = forloop.index0

    if current_cart_total >= ms_t
      assign prev_threshold = ms_t
    elsif progress_done == false
      assign progress_done = true
      if seg_index > 0
        assign filled = seg_index | minus: 1 | times: segment_size
        assign seg_diff = current_cart_total | minus: prev_threshold
        assign seg_range = ms_t | minus: prev_threshold
        if seg_range > 0
          assign partial = seg_diff | times: segment_size | divided_by: seg_range
        else
          assign partial = 0
        endif
        assign overall_progress = filled | plus: partial
      else
        assign overall_progress = 0
      endif
    endif
  endfor

  if progress_done == false
    if current_cart_total >= prev_threshold and prev_threshold > 0
      assign overall_progress = 100
    endif
  endif
%}

{% if ms_count > 0 %}
<div class="rpb" id="rewardsProgressBar">
  <!-- Message -->
  <div class="rpb__msg" id="rpbMsg">
    {% if all_done %}
      <div class="rpb__pill">All rewards unlocked!</div>
    {% else %}
      <div class="rpb__txt">Add <strong>&#8377;{{ next_rem }}</strong> more for <strong>{{ next_msg }}!</strong></div>
    {% endif %}
  </div>

  <!-- Sliding bar track -->
  <div class="rpb__track" id="rpbTrack">
    <div class="rpb__slider" id="rpbSlider" data-target="{{ overall_progress }}%" style="width: {{ overall_progress }}%; background: #235A49; position: absolute; top: 0; left: 0; height: 100%; border-radius: 10px; z-index: 1; display: block;"></div>

    {% comment %} Milestone dots on the track {% endcomment %}
    {% for ms in milestones %}
      {% assign parts = ms | split: ':' %}
      {% assign ms_t = parts[0] | plus: 0 %}
      {% assign dot_pos = forloop.index0 | times: segment_size %}
      <div class="rpb__dot {% if current_cart_total >= ms_t %}done{% endif %}" style="left: {{ dot_pos }}%;" data-idx="{{ forloop.index0 }}">
        {% if current_cart_total >= ms_t %}
          <svg viewBox="0 0 14 10" fill="none"><path d="M1 5l4 4L13 1" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        {% endif %}
      </div>
    {% endfor %}
  </div>

  <!-- Labels below track -->
  <div class="rpb__labels" style="--ms-count: {{ ms_count }};">
    {% for ms in milestones %}
      {% assign parts = ms | split: ':' %}
      {% assign ms_t = parts[0] | plus: 0 %}
      {% assign ms_disp = parts[1] %}
      {% assign ms_lbl = parts[2] %}
      {% assign ms_ico = parts[4] %}
      {% assign lbl_pos = forloop.index0 | times: segment_size %}
      <div class="rpb__label {% if current_cart_total >= ms_t %}done{% endif %}{% if forloop.first %} rpb__label--first{% endif %}{% if forloop.last %} rpb__label--last{% endif %}" style="left: {{ lbl_pos }}%;" data-idx="{{ forloop.index0 }}">
        <span class="rpb__ico">
          {% if ms_ico == 'truck' %}
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13" rx="2"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
          {% elsif ms_ico == 'gift' %}
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 010-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 000-5C13 2 12 7 12 7z"/></svg>
          {% elsif ms_ico == 'star' %}
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
          {% elsif ms_ico == 'percent' %}
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="5" x2="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></svg>
          {% endif %}
        </span>
        <span class="rpb__name">{{ ms_lbl }}</span>
        <span class="rpb__amt">&#8377;{{ ms_disp }}+</span>
      </div>
    {% endfor %}
  </div>
</div>

<style>
  .rpb {
    padding: 10px 16px 4px;
    background: #f4faf7;
    border-bottom: 1px solid #dde8e2;
  }

  /* Message */
  .rpb__msg { text-align: center; margin-bottom: 10px; }
  .rpb__txt {
    font-size: 12px;
    color: #555;
    font-family: 'Roboto Slab', serif;
  }
  .rpb__txt strong { color: #235A49; }
  .rpb__pill {
    display: inline-block;
    font-size: 11.5px;
    font-weight: 600;
    color: #235A49;
    background: rgba(35,90,73,0.1);
    padding: 5px 14px;
    border-radius: 20px;
    font-family: 'Roboto Slab', serif;
  }

  /* Track */
  .rpb__track {
    position: relative !important;
    height: 6px !important;
    background: #dce5df !important;
    border-radius: 10px;
    margin: 0 14px;
    overflow: visible;
  }

  /* Sliding green bar */
  .rpb__slider {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    height: 100% !important;
    min-height: 6px;
    background: #235A49 !important;
    border-radius: 10px;
    transition: width 1s ease;
    z-index: 1;
    display: block !important;
  }

  /* Milestone dots ON the track */
  .rpb__dot {
    position: absolute;
    top: 50%;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: #fff;
    border: 2.5px solid #c5d0c9;
    transform: translate(-50%, -50%);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 3;
    transition: none;
  }
  .rpb__dot svg { width: 10px; height: 10px; }
  .rpb__dot.done {
    background: #235A49;
    border-color: #1a4538;
    box-shadow: 0 0 0 3px rgba(35,90,73,0.15), 0 2px 6px rgba(35,90,73,0.2);
    transform: translate(-50%, -50%) scale(1.1);
  }

  /* Labels row */
  .rpb__labels {
    position: relative;
    height: 50px;
    margin: 0 14px;
  }
  .rpb__label {
    position: absolute;
    top: 6px;
    transform: translateX(-50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0;
  }
  .rpb__label--first {
    transform: translateX(0);
    align-items: flex-start;
  }
  .rpb__label--last {
    transform: translateX(-100%);
    align-items: flex-end;
  }
  .rpb__ico {
    display: flex;
    color: #a8b2ab;
    transition: none;
  }
  .rpb__ico svg { width: 15px; height: 15px; }
  .rpb__label.done .rpb__ico { color: #235A49; }

  .rpb__name {
    font-size: 10px;
    font-weight: 600;
    color: #888;
    font-family: 'Roboto Slab', serif;
    white-space: nowrap;
    transition: none;
  }
  .rpb__label.done .rpb__name { color: #235A49; font-weight: 700; }

  .rpb__amt {
    font-size: 9px;
    color: #aaa;
    font-family: 'Roboto Slab', serif;
    transition: none;
  }
  .rpb__label.done .rpb__amt { color: #3a8f6e; }

  /* Mobile */
  @media (max-width: 480px) {
    .rpb { padding: 8px 10px 2px; }
    .rpb__track { margin: 0 10px; height: 5px; }
    .rpb__labels { margin: 0 10px; height: 44px; }
    .rpb__txt { font-size: 11px; }
    .rpb__pill { font-size: 10.5px; padding: 4px 10px; }
    .rpb__dot { width: 18px; height: 18px; }
    .rpb__dot svg { width: 8px; height: 8px; }
    .rpb__ico svg { width: 13px; height: 13px; }
    .rpb__name { font-size: 9px; }
    .rpb__amt { font-size: 8px; }
  }
</style>

<script>
/** Animate slider from 0 to target width */
window.animateRewardsSlider = function() {
  var slider = document.getElementById('rpbSlider');
  if (!slider) return;
  var target = slider.getAttribute('data-target') || slider.style.width || '0%';
  slider.style.transition = 'none';
  slider.style.width = '0%';
  // Force reflow so the browser registers 0% before transitioning
  slider.offsetWidth;
  slider.style.transition = 'width 1s ease';
  slider.style.width = target;
};

window.updateCartRewards = function(cartTotal) {
  var milestones = [
    {% for ms in milestones %}
      {% assign p = ms | split: ':' %}
      { threshold: {{ p[0] }}, msg: '{{ p[3] }}' }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ];

  var total = cartTotal || {{ current_cart_total | default: 0 }};
  var count = milestones.length;
  var seg = count > 1 ? 100 / (count - 1) : 100;
  var slider = document.getElementById('rpbSlider');
  var msg = document.getElementById('rpbMsg');
  if (!slider) return;

  var reached = 0;
  var nextMsg = '', nextRem = 0, allDone = true;

  for (var i = 0; i < count; i++) {
    if (total >= milestones[i].threshold) {
      reached++;
    } else {
      allDone = false;
      if (!nextMsg) {
        nextMsg = milestones[i].msg;
        nextRem = Math.ceil((milestones[i].threshold - total) / 100);
      }
    }
  }

  var pct = 0;
  if (reached >= count) {
    pct = 100;
  } else if (reached > 0) {
    var prevT = milestones[reached - 1].threshold;
    var currT = milestones[reached].threshold;
    var filled = (reached - 1) * seg;
    var partial = ((total - prevT) / (currT - prevT)) * seg;
    pct = filled + partial;
  }

  var widthVal = Math.min(100, Math.max(0, pct)) + '%';
  slider.setAttribute('data-target', widthVal);
  slider.style.width = widthVal;

  if (msg) {
    msg.innerHTML = allDone
      ? '<div class="rpb__pill">All rewards unlocked!</div>'
      : '<div class="rpb__txt">Add <strong>\u20B9' + nextRem + '</strong> more for <strong>' + nextMsg + '!</strong></div>';
  }

  var dots = document.querySelectorAll('.rpb__dot');
  var lbls = document.querySelectorAll('.rpb__label');
  for (var j = 0; j < count; j++) {
    var done = total >= milestones[j].threshold;
    if (dots[j]) dots[j].classList.toggle('done', done);
    if (lbls[j]) lbls[j].classList.toggle('done', done);
  }
};
</script>
{% endif %}
